<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n de Entregas - Docentes Brown</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Hebrew:wght@300;400;600&family=League+Spartan:wght@500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#24496e',
                        'brand-cream': '#f3efdc',
                        'brand-gray': '#f4f4f5',
                    },
                    fontFamily: {
                        'spartan': ['"League Spartan"', 'sans-serif'],
                        'plex': ['"IBM Plex Sans Hebrew"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                        'float': '0 10px 25px -5px rgba(36, 73, 110, 0.2)',
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-checkbox input:checked + div {
            background-color: #24496e;
            border-color: #24496e;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }

        /* Spinner de carga */
        .loader {
            border: 3px solid #f3efdc; 
            border-top: 3px solid #24496e; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-center font-plex antialiased selection:bg-brand-cream selection:text-brand-blue">

    <div id="global-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Cargando datos...</p>
    </div>

    <main id="main-app" class="w-full max-w-md bg-white min-h-screen shadow-2xl relative overflow-hidden hidden">
        
        <header class="p-6 pb-2 text-center">
            <h1 class="text-brand-blue font-spartan font-bold text-xl tracking-tight uppercase">Docentes Brown</h1>
            <p class="text-gray-400 text-sm font-light">Gesti√≥n de env√≠os y entregas</p>
        </header>

        <section id="screen-home" class="flex flex-col gap-4 p-6 h-[80vh] justify-center fade-in">
            <button onclick="navTo('screen-envio')" class="group relative overflow-hidden bg-brand-blue text-white h-48 rounded-3xl shadow-float flex flex-col items-center justify-center transition transform active:scale-95">
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-5 transition"></div>
                <span class="text-5xl mb-2">üöö</span>
                <span class="font-spartan font-bold text-2xl tracking-wide z-10">SOLICITAR ENV√çO</span>
                <span class="text-brand-cream text-sm mt-1 opacity-80 z-10">A domicilio</span>
            </button>

            <button onclick="navTo('screen-retiro')" class="group relative overflow-hidden bg-white border-2 border-brand-blue text-brand-blue h-48 rounded-3xl shadow-card flex flex-col items-center justify-center transition transform active:scale-95">
                <span class="text-5xl mb-2">üìç</span>
                <span class="font-spartan font-bold text-2xl tracking-wide">RETIRO PRESENCIAL</span>
                <span class="text-gray-500 text-sm mt-1">Puntos de encuentro</span>
            </button>
        </section>

        <section id="screen-envio" class="hidden p-6 fade-in pb-24">
            <div class="flex items-center mb-6">
                <button onclick="navTo('screen-home')" class="text-brand-blue p-2 -ml-2"><i class="fa-solid fa-arrow-left"></i> ‚Üê Volver</button>
                <h2 class="font-spartan font-bold text-2xl text-brand-blue ml-auto">Datos de Env√≠o</h2>
            </div>

            <form id="shippingForm" onsubmit="sendShipping(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Nombre y Apellido</label>
                    <input type="text" id="nombre" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue focus:ring-1 focus:ring-brand-blue transition">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">DNI</label>
                        <input type="tel" id="dni" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Celular</label>
                        <input type="tel" id="celular" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue transition">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Email</label>
                    <input type="email" id="mail" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Direcci√≥n</label>
                    <input type="text" id="direccion" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue transition">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">C√≥digo Postal</label>
                    <input type="tel" id="cp" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg focus:outline-none focus:border-brand-blue transition">
                </div>

                <div class="fixed bottom-0 left-0 w-full p-6 bg-white border-t border-gray-100 max-w-md mx-auto z-50">
                    <button type="submit" class="w-full bg-brand-blue text-white font-spartan font-bold text-lg py-4 rounded-2xl shadow-float active:scale-95 transition">
                        ENVIAR POR WHATSAPP
                    </button>
                </div>
            </form>
        </section>

        <section id="screen-retiro" class="hidden p-6 fade-in pb-10">
            <div class="flex items-center mb-6">
                <button onclick="navTo('screen-home')" class="text-brand-blue p-2 -ml-2">‚Üê Volver</button>
                <h2 class="font-spartan font-bold text-2xl text-brand-blue ml-auto">Puntos de Retiro</h2>
            </div>

            <div id="accordion-container" class="space-y-4 pb-20">
                </div>
        </section>

    </main>

    <script>
        // ==========================================
        // üîó CONEXI√ìN CON GOOGLE SHEETS
        // ==========================================
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3umh1n0156ItF44fpX3nL-lN-w_noV95rHknHJHjgaRXVrTQp2hygw2D6ev-qaQ_S8wp_HhP8_YXT/pub?output=csv";
        const WHATSAPP_ENVIOS = "5491153196358";
        
        let DATA_CONFIG = [];

        // 1. INICIALIZAR APP (Cargar datos)
        window.onload = async () => {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                DATA_CONFIG = parseCSV(text);
                
                renderAccordions(); // Crear las tarjetas con los datos descargados
                
                // Ocultar pantalla de carga y mostrar app
                document.getElementById('global-loader').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('main-app').classList.add('fade-in');

            } catch (error) {
                console.error("Error cargando Sheet:", error);
                alert("Hubo un error cargando los horarios. Por favor revisa tu conexi√≥n.");
            }
        };

        // 2. PARSEAR CSV (Convertir texto de Excel a Objetos JS)
        function parseCSV(csvText) {
            // Dividir por l√≠neas y saltar la primera (encabezados)
            const rows = csvText.split('\n').slice(1);
            
            return rows.map(row => {
                // Dividir columnas por coma
                const cols = row.split(',');
                
                // Validar que la fila tenga datos
                if (cols.length < 4) return null;

                // Limpiar comillas extras si Google las agrega y espacios
                const titulo = cols[0]?.replace(/"/g, '').trim();
                const subtitulo = cols[1]?.replace(/"/g, '').trim();
                const whatsapp = cols[2]?.replace(/"/g, '').trim();
                const opcionesRaw = cols[3]?.replace(/"/g, '').trim();

                // Separar los horarios por el gui√≥n "-"
                const opciones = opcionesRaw ? opcionesRaw.split('-').map(op => op.trim()) : [];

                return { titulo, subtitulo, whatsapp, opciones };
            }).filter(item => item !== null && item.titulo !== ""); // Filtrar filas vac√≠as
        }


        // ==========================================
        // üöÄ L√ìGICA FUNCIONAL (UI)
        // ==========================================

        function navTo(screenId) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            document.getElementById(screenId).classList.add('fade-in');
            window.scrollTo(0,0);
        }

        // L√≥gica ENV√çOS
        function sendShipping(e) {
            e.preventDefault();
            const datos = {
                nombre: document.getElementById('nombre').value,
                dni: document.getElementById('dni').value,
                cel: document.getElementById('celular').value,
                mail: document.getElementById('mail').value,
                dir: document.getElementById('direccion').value,
                cp: document.getElementById('cp').value
            };
            const mensaje = `Hola, Docentes Brown! Env√≠o los datos necesarios para gestionar el env√≠o:%0ANombre: ${datos.nombre}%0ADNI: ${datos.dni}%0ACelular: ${datos.cel}%0AMail: ${datos.mail}%0ADirecci√≥n: ${datos.dir}%0ACP: ${datos.cp}`;
            window.open(`https://wa.me/${WHATSAPP_ENVIOS}?text=${mensaje}`, '_blank');
        }

        // L√≥gica RETIROS
        function renderAccordions() {
            const container = document.getElementById('accordion-container');
            container.innerHTML = ''; 

            if(DATA_CONFIG.length === 0) {
                container.innerHTML = "<p class='text-center text-gray-400'>No hay horarios disponibles.</p>";
                return;
            }

            DATA_CONFIG.forEach((loc, index) => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-card overflow-hidden border border-gray-100 transition-all duration-300";
                
                const header = document.createElement('div');
                header.className = "p-5 flex justify-between items-center cursor-pointer active:bg-gray-50";
                header.onclick = () => toggleAccordion(index);
                header.innerHTML = `
                    <div>
                        <h3 class="font-spartan font-bold text-xl text-brand-blue">${loc.titulo}</h3>
                        <p class="text-gray-400 text-sm">${loc.subtitulo}</p>
                    </div>
                    <span id="icon-${index}" class="text-brand-blue text-2xl transition-transform duration-300 transform rotate-0">‚ñº</span>
                `;

                const body = document.createElement('div');
                body.id = `body-${index}`;
                body.className = "hidden px-5 pb-5 bg-gray-50 border-t border-gray-100";
                
                let optionsHtml = '<div class="space-y-3 mt-4">';
                loc.opciones.forEach(horario => {
                    optionsHtml += `
                        <label class="custom-checkbox flex items-center p-3 bg-white rounded-xl border border-gray-200 cursor-pointer hover:border-brand-blue transition">
                            <input type="radio" name="horario-${index}" value="${horario}" class="hidden" onchange="enableConfirm(${index})">
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 transition-colors">
                                <svg class="w-3 h-3 text-white hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            </div>
                            <span class="text-gray-700 font-medium">${horario}</span>
                        </label>
                    `;
                });
                optionsHtml += '</div>';

                optionsHtml += `
                    <button id="btn-${index}" disabled 
                        onclick="sendPickup(${index})"
                        class="w-full mt-5 bg-gray-300 text-white font-spartan font-bold py-3 rounded-xl transition cursor-not-allowed">
                        CONFIRMAR
                    </button>
                `;

                body.innerHTML = optionsHtml;
                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
            });
        }

        function toggleAccordion(index) {
            const body = document.getElementById(`body-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isHidden = body.classList.contains('hidden');
            document.querySelectorAll('[id^="body-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="icon-"]').forEach(el => el.classList.remove('rotate-180'));
            if (isHidden) {
                body.classList.remove('hidden');
                icon.classList.add('rotate-180');
            }
        }

        function enableConfirm(index) {
            const btn = document.getElementById(`btn-${index}`);
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-brand-blue', 'shadow-lg', 'active:scale-95');
        }

        function sendPickup(index) {
            const loc = DATA_CONFIG[index];
            const radios = document.getElementsByName(`horario-${index}`);
            let selectedTime = '';
            for(const radio of radios) {
                if(radio.checked) selectedTime = radio.value;
            }
            const mensaje = `Hola! Te escribo para coordinar la entrega en ${loc.titulo}.%0AHorario elegido: ${selectedTime}`;
            window.open(`https://wa.me/${loc.whatsapp}?text=${mensaje}`, '_blank');
        }
    </script>
</body>
</html>
